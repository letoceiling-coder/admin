import{m as S,o as a,c as l,a as e,w as N,g as T,v as $,t as n,f as h,i as H,n as P,F as U,A as q,l as d,x as k}from"./app-25073f1d.js";const R={class:"commercial-proposal-page"},G={class:"grid gap-6 lg:grid-cols-2"},I={class:"space-y-4"},J={class:"bg-card rounded-lg border border-border p-4 sm:p-6"},K={key:0,class:"mt-1 text-sm text-destructive"},O={class:"flex flex-wrap gap-2"},Q=["disabled"],W={key:0,class:"h-4 w-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},X={key:1,class:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Y=["disabled"],Z={class:"bg-card rounded-lg border border-border overflow-hidden flex flex-col"},ee={class:"p-4 border-b border-border flex items-center justify-between"},te={key:0,class:"text-sm text-muted-foreground"},se={class:"flex-1 min-h-[400px] bg-muted/30 overflow-auto p-4"},oe=["srcdoc"],ae={key:1,class:"flex items-center justify-center h-64 text-muted-foreground"},le={class:"mt-8 bg-card rounded-lg border border-border overflow-hidden"},re={class:"p-4 border-b border-border flex items-center justify-between"},ne=["disabled"],de={class:"overflow-x-auto"},ie={class:"w-full text-sm text-left"},ue={class:"divide-y divide-border"},ce={key:0,class:"bg-card"},me={key:1,class:"bg-card"},pe={class:"px-4 py-3 font-medium text-foreground"},ge={class:"px-4 py-3 text-muted-foreground"},ve={class:"px-4 py-3 text-muted-foreground"},be={class:"px-4 py-3"},fe={class:"px-4 py-3"},xe=["disabled","title","onClick"],_e={key:0,class:"h-4 w-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},ye={key:1,class:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},he={key:1,class:"text-muted-foreground text-xs"},ke={key:0,class:"p-4 border-t border-border flex items-center justify-between"},we={class:"text-sm text-muted-foreground"},Ce={class:"flex gap-2"},Me=["disabled"],je=["disabled"],ze={__name:"CommercialProposalPage",setup(Be){const g=d(""),v=d(""),b=d(!1),i=d(""),c=d(!1),w=d(""),f=d(!1),A=d(null),x=d([]),_=d(!1),r=d(null),u=d({});function C(){i.value="",v.value=""}function D(o){return o?new Date(o).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—"}async function M(){f.value=!0,C();try{const{data:o}=await k.get("/admin/commercial-proposal/preview");w.value=o.html??""}catch{i.value="Не удалось загрузить предпросмотр.",c.value=!1}finally{f.value=!1}}async function y(o=1){_.value=!0;try{const{data:t}=await k.get("/admin/commercial-proposal/mailings",{params:{page:o,per_page:20}});x.value=t.data??[],r.value={current_page:t.current_page,last_page:t.last_page,prev_page_url:t.prev_page_url,next_page_url:t.next_page_url}}catch{x.value=[],r.value=null}finally{_.value=!1}}function j(o){o<1||y(o)}async function E(){var o,t,s,m,p,B,V;if(v.value="",!((o=g.value)!=null&&o.trim())){v.value="Укажите email.";return}b.value=!0,C();try{await k.post("/admin/commercial-proposal/send",{email:g.value.trim()}),i.value="Коммерческое предложение отправлено на указанный email.",c.value=!0,g.value="",y(1)}catch(z){const L=((s=(t=z.response)==null?void 0:t.data)==null?void 0:s.message)??((V=(B=(p=(m=z.response)==null?void 0:m.data)==null?void 0:p.errors)==null?void 0:B.email)==null?void 0:V[0])??"Ошибка отправки.";i.value=L,c.value=!1}finally{b.value=!1}}async function F(o){var t,s,m;if(o.can_send){u.value={...u.value,[o.email]:!0},C();try{const{data:p}=await k.post("/admin/commercial-proposal/resend",{email:o.email});i.value=p.message??"КП повторно отправлено.",c.value=!0,y(((t=r.value)==null?void 0:t.current_page)??1)}catch(p){i.value=((m=(s=p.response)==null?void 0:s.data)==null?void 0:m.message)??"Ошибка повторной отправки.",c.value=!1}finally{u.value={...u.value,[o.email]:!1}}}}return S(()=>{M(),y()}),(o,t)=>(a(),l("div",R,[t[14]||(t[14]=e("div",{class:"mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"},[e("div",null,[e("h1",{class:"text-2xl font-bold text-foreground"},"Рассылка коммерческого предложения"),e("p",{class:"text-muted-foreground mt-1"},"Отправка КП на указанный email с предпросмотром")])],-1)),e("div",G,[e("div",I,[e("div",J,[t[6]||(t[6]=e("h2",{class:"text-lg font-semibold text-foreground mb-4"},"Отправить КП",-1)),e("form",{onSubmit:N(E,["prevent"]),class:"space-y-4"},[e("div",null,[t[3]||(t[3]=e("label",{for:"email",class:"block text-sm font-medium text-foreground mb-1"},"Email получателя",-1)),T(e("input",{id:"email","onUpdate:modelValue":t[0]||(t[0]=s=>g.value=s),type:"email",required:"",placeholder:"client@example.com",class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[$,g.value]]),v.value?(a(),l("p",K,n(v.value),1)):h("",!0)]),e("div",O,[e("button",{type:"submit",class:"inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:b.value},[b.value?(a(),l("svg",W,[...t[4]||(t[4]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(a(),l("svg",X,[...t[5]||(t[5]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"},null,-1)])])),H(" "+n(b.value?"Отправка…":"Отправить КП"),1)],8,Q),e("button",{type:"button",class:"inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-foreground hover:bg-accent/10 transition-colors",disabled:f.value,onClick:M},n(f.value?"Загрузка…":"Обновить предпросмотр"),9,Y)])],32),i.value?(a(),l("p",{key:0,class:P(["mt-3 text-sm",c.value?"text-green-600 dark:text-green-400":"text-destructive"])},n(i.value),3)):h("",!0)])]),e("div",Z,[e("div",ee,[t[7]||(t[7]=e("h2",{class:"text-lg font-semibold text-foreground"},"Предпросмотр письма",-1)),f.value?(a(),l("span",te,"Загрузка…")):h("",!0)]),e("div",se,[w.value?(a(),l("iframe",{key:0,ref_key:"previewFrame",ref:A,title:"Предпросмотр коммерческого предложения",class:"w-full min-h-[500px] border-0 rounded-lg bg-white shadow-sm",sandbox:"allow-same-origin",srcdoc:w.value},null,8,oe)):(a(),l("div",ae," Нажмите «Обновить предпросмотр», чтобы увидеть письмо "))])])]),e("div",le,[e("div",re,[t[8]||(t[8]=e("h2",{class:"text-lg font-semibold text-foreground"},"История рассылок",-1)),e("button",{type:"button",class:"rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 transition-colors disabled:opacity-50",disabled:_.value,onClick:y},n(_.value?"Загрузка…":"Обновить"),9,ne)]),e("div",de,[e("table",ie,[t[13]||(t[13]=e("thead",{class:"bg-muted/50 text-muted-foreground uppercase"},[e("tr",null,[e("th",{class:"px-4 py-3 font-medium"},"Email"),e("th",{class:"px-4 py-3 font-medium"},"Отправлено раз"),e("th",{class:"px-4 py-3 font-medium"},"Дата последней"),e("th",{class:"px-4 py-3 font-medium"},"Доступность"),e("th",{class:"px-4 py-3 font-medium"},"Действия")])],-1)),e("tbody",ue,[_.value&&!x.value.length?(a(),l("tr",ce,[...t[9]||(t[9]=[e("td",{colspan:"5",class:"px-4 py-8 text-center text-muted-foreground"},"Загрузка…",-1)])])):x.value.length?h("",!0):(a(),l("tr",me,[...t[10]||(t[10]=[e("td",{colspan:"5",class:"px-4 py-8 text-center text-muted-foreground"},"Рассылок пока нет",-1)])])),(a(!0),l(U,null,q(x.value,s=>(a(),l("tr",{key:s.email,class:"bg-card hover:bg-accent/5 transition-colors"},[e("td",pe,n(s.email),1),e("td",ge,n(s.send_count??0),1),e("td",ve,n(D(s.last_sent_at)),1),e("td",be,[e("span",{class:P(["inline-flex rounded-full px-2 py-0.5 text-xs font-medium",s.can_send?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300":"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300"])},n(s.can_send?"Можно":"Не беспокоить"),3)]),e("td",fe,[s.can_send?(a(),l("button",{key:0,type:"button",class:"inline-flex items-center gap-1.5 rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:u.value[s.email],title:"Повторить отправку на "+s.email,onClick:m=>F(s)},[u.value[s.email]?(a(),l("svg",_e,[...t[11]||(t[11]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(a(),l("svg",ye,[...t[12]||(t[12]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])),H(" "+n(u.value[s.email]?"Отправка…":"Повторить"),1)],8,xe)):(a(),l("span",he,"—"))])]))),128))])])]),r.value&&(r.value.prev_page_url||r.value.next_page_url)?(a(),l("div",ke,[e("p",we," Страница "+n(r.value.current_page)+" из "+n(r.value.last_page),1),e("div",Ce,[e("button",{type:"button",class:"rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!r.value.prev_page_url,onClick:t[1]||(t[1]=s=>j(r.value.current_page-1))}," Назад ",8,Me),e("button",{type:"button",class:"rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!r.value.next_page_url,onClick:t[2]||(t[2]=s=>j(r.value.current_page+1))}," Вперёд ",8,je)])])):h("",!0)])]))}};export{ze as default};
