import{m as L,o as l,c as a,a as e,w as S,g as $,v as N,t as d,f as h,i as H,n as T,F as U,A as q,l as n,x as w}from"./app-1a5e3182.js";const R={class:"commercial-proposal-page"},G={class:"grid gap-6 lg:grid-cols-2"},I={class:"space-y-4"},J={class:"bg-card rounded-lg border border-border p-4 sm:p-6"},K={key:0,class:"mt-1 text-sm text-destructive"},O={class:"flex flex-wrap gap-2"},Q=["disabled"],W={key:0,class:"h-4 w-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},X={key:1,class:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Y=["disabled"],Z={class:"bg-card rounded-lg border border-border overflow-hidden flex flex-col"},ee={class:"p-4 border-b border-border flex items-center justify-between"},te={key:0,class:"text-sm text-muted-foreground"},oe={class:"flex-1 min-h-[400px] bg-muted/30 overflow-auto p-4"},se=["srcdoc"],le={key:1,class:"flex items-center justify-center h-64 text-muted-foreground"},ae={class:"mt-8 bg-card rounded-lg border border-border overflow-hidden"},re={class:"p-4 border-b border-border flex items-center justify-between"},ne=["disabled"],de={class:"overflow-x-auto"},ie={class:"w-full text-sm text-left"},ue={class:"divide-y divide-border"},ce={key:0,class:"bg-card"},me={key:1,class:"bg-card"},pe={class:"px-4 py-3 font-medium text-foreground"},ge={class:"px-4 py-3 text-muted-foreground"},ve={class:"px-4 py-3"},be=["disabled","title","onClick"],fe={key:0,class:"h-4 w-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},xe={key:1,class:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},_e={key:0,class:"p-4 border-t border-border flex items-center justify-between"},ye={class:"text-sm text-muted-foreground"},he={class:"flex gap-2"},we=["disabled"],ke=["disabled"],je={__name:"CommercialProposalPage",setup(Ce){const g=n(""),v=n(""),b=n(!1),i=n(""),c=n(!1),k=n(""),f=n(!1),P=n(null),x=n([]),_=n(!1),r=n(null),u=n({});function C(){i.value="",v.value=""}function A(o){return o?new Date(o).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—"}async function M(){f.value=!0,C();try{const{data:o}=await w.get("/admin/commercial-proposal/preview");k.value=o.html??""}catch{i.value="Не удалось загрузить предпросмотр.",c.value=!1}finally{f.value=!1}}async function y(o=1){_.value=!0;try{const{data:t}=await w.get("/admin/commercial-proposal/mailings",{params:{page:o,per_page:20}});x.value=t.data??[],r.value={current_page:t.current_page,last_page:t.last_page,prev_page_url:t.prev_page_url,next_page_url:t.next_page_url}}catch{x.value=[],r.value=null}finally{_.value=!1}}function j(o){o<1||y(o)}async function D(){var o,t,s,m,p,B,V;if(v.value="",!((o=g.value)!=null&&o.trim())){v.value="Укажите email.";return}b.value=!0,C();try{await w.post("/admin/commercial-proposal/send",{email:g.value.trim()}),i.value="Коммерческое предложение отправлено на указанный email.",c.value=!0,g.value="",y(1)}catch(z){const F=((s=(t=z.response)==null?void 0:t.data)==null?void 0:s.message)??((V=(B=(p=(m=z.response)==null?void 0:m.data)==null?void 0:p.errors)==null?void 0:B.email)==null?void 0:V[0])??"Ошибка отправки.";i.value=F,c.value=!1}finally{b.value=!1}}async function E(o){var t,s,m;u.value={...u.value,[o.id]:!0},C();try{const{data:p}=await w.post(`/admin/commercial-proposal/mailings/${o.id}/resend`);i.value=p.message??"КП повторно отправлено.",c.value=!0,y(((t=r.value)==null?void 0:t.current_page)??1)}catch(p){i.value=((m=(s=p.response)==null?void 0:s.data)==null?void 0:m.message)??"Ошибка повторной отправки.",c.value=!1}finally{u.value={...u.value,[o.id]:!1}}}return L(()=>{M(),y()}),(o,t)=>(l(),a("div",R,[t[14]||(t[14]=e("div",{class:"mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"},[e("div",null,[e("h1",{class:"text-2xl font-bold text-foreground"},"Рассылка коммерческого предложения"),e("p",{class:"text-muted-foreground mt-1"},"Отправка КП на указанный email с предпросмотром")])],-1)),e("div",G,[e("div",I,[e("div",J,[t[6]||(t[6]=e("h2",{class:"text-lg font-semibold text-foreground mb-4"},"Отправить КП",-1)),e("form",{onSubmit:S(D,["prevent"]),class:"space-y-4"},[e("div",null,[t[3]||(t[3]=e("label",{for:"email",class:"block text-sm font-medium text-foreground mb-1"},"Email получателя",-1)),$(e("input",{id:"email","onUpdate:modelValue":t[0]||(t[0]=s=>g.value=s),type:"email",required:"",placeholder:"client@example.com",class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[N,g.value]]),v.value?(l(),a("p",K,d(v.value),1)):h("",!0)]),e("div",O,[e("button",{type:"submit",class:"inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:b.value},[b.value?(l(),a("svg",W,[...t[4]||(t[4]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(l(),a("svg",X,[...t[5]||(t[5]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"},null,-1)])])),H(" "+d(b.value?"Отправка…":"Отправить КП"),1)],8,Q),e("button",{type:"button",class:"inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-foreground hover:bg-accent/10 transition-colors",disabled:f.value,onClick:M},d(f.value?"Загрузка…":"Обновить предпросмотр"),9,Y)])],32),i.value?(l(),a("p",{key:0,class:T(["mt-3 text-sm",c.value?"text-green-600 dark:text-green-400":"text-destructive"])},d(i.value),3)):h("",!0)])]),e("div",Z,[e("div",ee,[t[7]||(t[7]=e("h2",{class:"text-lg font-semibold text-foreground"},"Предпросмотр письма",-1)),f.value?(l(),a("span",te,"Загрузка…")):h("",!0)]),e("div",oe,[k.value?(l(),a("iframe",{key:0,ref_key:"previewFrame",ref:P,title:"Предпросмотр коммерческого предложения",class:"w-full min-h-[500px] border-0 rounded-lg bg-white shadow-sm",sandbox:"allow-same-origin",srcdoc:k.value},null,8,se)):(l(),a("div",le," Нажмите «Обновить предпросмотр», чтобы увидеть письмо "))])])]),e("div",ae,[e("div",re,[t[8]||(t[8]=e("h2",{class:"text-lg font-semibold text-foreground"},"История рассылок",-1)),e("button",{type:"button",class:"rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 transition-colors disabled:opacity-50",disabled:_.value,onClick:y},d(_.value?"Загрузка…":"Обновить"),9,ne)]),e("div",de,[e("table",ie,[t[13]||(t[13]=e("thead",{class:"bg-muted/50 text-muted-foreground uppercase"},[e("tr",null,[e("th",{class:"px-4 py-3 font-medium"},"Email"),e("th",{class:"px-4 py-3 font-medium"},"Дата отправки"),e("th",{class:"px-4 py-3 font-medium"},"Действия")])],-1)),e("tbody",ue,[_.value&&!x.value.length?(l(),a("tr",ce,[...t[9]||(t[9]=[e("td",{colspan:"3",class:"px-4 py-8 text-center text-muted-foreground"},"Загрузка…",-1)])])):x.value.length?h("",!0):(l(),a("tr",me,[...t[10]||(t[10]=[e("td",{colspan:"3",class:"px-4 py-8 text-center text-muted-foreground"},"Рассылок пока нет",-1)])])),(l(!0),a(U,null,q(x.value,s=>(l(),a("tr",{key:s.id,class:"bg-card hover:bg-accent/5 transition-colors"},[e("td",pe,d(s.email),1),e("td",ge,d(A(s.sent_at)),1),e("td",ve,[e("button",{type:"button",class:"inline-flex items-center gap-1.5 rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:u.value[s.id],title:"Повторить отправку на "+s.email,onClick:m=>E(s)},[u.value[s.id]?(l(),a("svg",fe,[...t[11]||(t[11]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(l(),a("svg",xe,[...t[12]||(t[12]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])),H(" "+d(u.value[s.id]?"Отправка…":"Повторить"),1)],8,be)])]))),128))])])]),r.value&&(r.value.prev_page_url||r.value.next_page_url)?(l(),a("div",_e,[e("p",ye," Страница "+d(r.value.current_page)+" из "+d(r.value.last_page),1),e("div",he,[e("button",{type:"button",class:"rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!r.value.prev_page_url,onClick:t[1]||(t[1]=s=>j(r.value.current_page-1))}," Назад ",8,we),e("button",{type:"button",class:"rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium text-foreground hover:bg-accent/10 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!r.value.next_page_url,onClick:t[2]||(t[2]=s=>j(r.value.current_page+1))}," Вперёд ",8,ke)])])):h("",!0)])]))}};export{je as default};
